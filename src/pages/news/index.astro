---
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";
import { formatDateLong } from "@/utils/time";
import { countWords, minutesToRead, truncateForPreview } from "@/utils/content";
import { Icon } from "astro-icon/components";

const posts = (await getCollection("posts")).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postsWithMeta = posts.map((p) => {
  const words = countWords(p.body ?? "");
  const excerpt = truncateForPreview(p.body ?? "", 512);
  return {
    ...p,
    words,
    mins: minutesToRead(words),
    excerpt,
  };
});
---

<Layout title="News" description="News and updates from PaperMC" keywords={["blog", "news", "updates", "latest"]} canonical="/news">
  <div class="container mx-auto mt-10 max-w-7xl px-4 py-12">
    <div class="flex flex-col gap-4">
      {
        postsWithMeta.map((entry, idx) => (
          <a href={`/news/${entry.id}`} class="group rounded-lg">
            <div class="btn btn-outline btn-gray flex flex-col gap-6 rounded-lg py-6 transition-all duration-200">
              <div class="flex flex-col gap-3 p-6">
                <div class="flex items-baseline justify-between gap-4">
                  <h2 class="text-foreground group-hover:text-primary text-xl leading-tight font-bold text-balance">{entry.data.title}</h2>
                  {idx === 0 ? (
                    <span class="bg-channel-stable-primary text-channel-stable-secondary shadow-channel-stable-primary/50 ml-4 inline-flex items-center rounded-sm px-2.5 py-0.5 text-xs font-semibold shadow-sm">
                      Latest
                    </span>
                  ) : null}
                </div>

                <div class="text-muted-foreground text-xs">
                  <div class="flex flex-row flex-wrap items-baseline gap-x-3 gap-y-1">
                    <span class="inline-flex items-baseline gap-1.5">
                      <Icon name="icons/lucide/calendar" class="size-3.5 translate-y-px" />
                      <span>{formatDateLong(new Date(entry.data.date))}</span>
                    </span>

                    <span aria-hidden="true">Â·</span>

                    <span class="inline-flex items-baseline gap-1.5">
                      <Icon name="icons/lucide/clock" class="size-3.5 translate-y-px" />
                      <span>{entry.mins} min read</span>
                    </span>
                  </div>
                </div>

                <p class="text-muted-foreground mask-fade-bottom max-h-28 overflow-hidden text-sm leading-relaxed [--fade-size:2.5rem]">
                  {entry.excerpt}
                </p>
              </div>
            </div>
          </a>
        ))
      }
    </div>
  </div>
</Layout>

<style scoped>
  @view-transition {
    navigation: auto;
  }
</style>
